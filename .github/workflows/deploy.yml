name: Build and Deploy ASP.NET Core MVC to Remote IIS

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # ğŸ§¾ Step 1: Checkout your code
    - name: âœ… Checkout Code
      uses: actions/checkout@v3

    # ğŸ›  Step 2: Setup .NET SDK
    - name: ğŸ›  Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # ğŸ§± Step 3: Restore, Build and Publish your project
    - name: ğŸ“¦ Build and Publish
      run: |
        echo "ğŸ”„ Restoring..."
        dotnet restore | Tee-Object -FilePath logs/restore.log

        echo "ğŸ— Building..."
        dotnet build --configuration Release | Tee-Object -FilePath logs/build.log

        echo "ğŸš€ Publishing..."
        dotnet publish --configuration Release --output publish_output | Tee-Object -FilePath logs/publish.log

    # ğŸ“¤ Step 4: Deploy to Remote IIS Server over WinRM
    - name: ğŸ“¤ Deploy to IIS via WinRM
      uses: appleboy/winrm-action@v1.0.2
      with:
        host: ${{ secrets.IIS_SERVER }}
        username: ${{ secrets.IIS_USERNAME }}
        password: ${{ secrets.IIS_PASSWORD }}
        port: 5985
        transport: http
        script: |
          Write-Output "ğŸ” Connecting to remote IIS server..."
          $sitePath = "${{ secrets.IIS_SITE_PATH }}"
          
          Write-Output "ğŸ§¹ Cleaning IIS folder: $sitePath"
          Remove-Item -Path "$sitePath\*" -Recurse -Force -ErrorAction SilentlyContinue

          Write-Output "ğŸ“ Copying files..."
          Copy-Item -Path "${{ github.workspace }}\publish_output\*" -Destination "$sitePath" -Recurse -Force

          Write-Output "â™» Restarting IIS..."
          iisreset

          Write-Output "âœ… Deployment complete."

    # ğŸ“œ Step 5: Upload Logs as Artifact
    - name: â˜ Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-and-deploy-logs
        path: logs
